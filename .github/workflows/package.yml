name: Package Windows Installer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: git update-index --chmod=+x gradlew
      shell: bash

    - name: Build with Gradle
      run: ./gradlew build copyDependencies

    - name: Create Runtime Image
      run: |
        jlink --module-path "$env:JAVA_HOME\jmods;build\libs\libs;build\libs" `
              --add-modules javafx.controls,javafx.fxml,javafx.graphics,java.sql,java.naming `
              --output build\runtime `
              --strip-debug `
              --no-header-files `
              --no-man-pages

    - name: Package MSI
      run: |
        jpackage --name "Lax Yard and SME Manager" `
                 --vendor "RASolutions" `
                 --app-version "1.0" `
                 --input build\libs `
                 --dest build\dist `
                 --main-jar sme-mngr.jar `
                 --main-class com.lax.sme_manager.LaxSmeManagerStarter `
                 --runtime-image build\runtime `
                 --type msi `
                 --win-dir-chooser `
                 --win-menu `
                 --win-shortcut

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: Windows-MSI-Installer
        path: build/dist/*.msi
