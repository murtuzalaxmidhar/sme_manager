name: Package Windows Installer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: git update-index --chmod=+x gradlew
      shell: bash

    - name: Build with Gradle
      run: ./gradlew build copyDependencies

    - name: Create Runtime Image
      run: |
        jlink --module-path "$env:JAVA_HOME\jmods;build\libs\libs;build\libs" `
              --add-modules javafx.controls,javafx.fxml,javafx.graphics,java.sql,java.naming `
              --output build\runtime `
              --strip-debug `
              --no-header-files `
              --no-man-pages

    - name: Package MSI
      run: |
        jpackage --name "Lax Yard and SME Manager" `
                 --vendor "RASolutions" `
                 --app-version "1.0" `
                 --input build\libs `
                 --dest build\dist `
                 --main-jar sme-mngr.jar `
                 --main-class com.lax.sme_manager.LaxSmeManagerStarter `
                 --runtime-image build\runtime `
                 --type msi `
                 --win-dir-chooser `
                 --win-menu `
                 --win-shortcut

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: Windows-MSI-Installer
        path: build/dist/*.msi

    - name: Upload MSI to Google Drive
      uses: adityak74/google-drive-upload-git-action@main
      with:
        credentials: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON_BASE64 }}
        filename: "build/dist/*.msi"
        folderId: ${{ secrets.GDRIVE_FOLDER_ID }}
        overwrite: "true"

    - name: Email Notification (via Gmail)
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "ðŸ“¦ Lax SME Manager: New Update Available"
        to: "laxmidharmurtuza11072@gmail.com"
        from: "Lax Manager CI"
        body: |
          Hi,

          A new version of the Yard Manager software (Build #${{ github.run_number }}) is now ready on your Google Drive.

          Notes: ${{ github.event.head_commit.message }}

          Please install it at your convenience.
